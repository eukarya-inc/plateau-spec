# 附属書B 妥当な幾何オブジェクト

## 附属書B （規定） 妥当な幾何オブジェクト

## B.1 概要

本付属書では、「3D都市モデル標準製品仕様書」（以下、「標準製品仕様書」という）に適合したデータ製品について、妥当な幾何オブジェクトの要件を示す。

**表 B-1 — B-1: 妥当な幾何オブジェクト**

| ID | `/req/gm` |
| --- | --- |
| 対象の種類 | 妥当な幾何オブジェクトの要件 |
| 説明 | 幾何オブジェクトの説明 |
| 規定 | 要件B-1: 日本測地系2011に基づく3次元座標の空間参照系要件B-2: データ集合の範囲を示す空間参照系要件B-3: 座標値の空間参照系適合要件B-4: 曲線記述のためのgml:LineString使用要件B-5: 妥当なgml:LineStringの条件要件B-6: gml:LinearRingの妥当性条件要件B-7: 曲面記述のためのgml:Polygon使用要件B-8: gml:Polygonの外周と内周の関係要件B-9: gml:Polygonの向きと頂点の順列要件B-10: gml:Polygonの妥当性条件要件B-11: gml:CompositeSurfaceの妥当性条件要件B-12: 立体記述のためのgml:Solid使用要件B-13: gml:Solidの外側境界と内側境界要件B-14: gml:Solidの妥当性条件要件B-15: gml:Triangleの外周と内周の制約要件B-16: gml:TriangulatedSurfaceの構成要素要件B-17: gml:Tinの制御点と三角形の条件推奨B-1: 幾何オブジェクトの空間参照系条件推奨B-2: 3D都市モデルの座標参照系条件推奨B-3: 2次元幾何の高さ設定条件推奨B-4: 3Dモデルメタデータの仮想高さ明記条件 |

## B.2 空間参照系

空間参照系は、実世界における位置を識別するための体系であり、位置を座標により記述する場合には、原点や軸の方向、座標の単位等の取り決めが含まれる。座標が地球上のどこであるかを示すには、空間参照系を指定しなければならない。

**表 B-2 — B-1: 日本測地系2011に基づく3次元座標の空間参照系**

| ID | `/req/gm/1` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | データ製品に含まれる幾何オブジェクトの3次元座標の空間参照系は、「日本測地系2011における経緯度座標系と東京湾平均海面を基準とする標高の複合座標参照系」とする。 |

3D都市モデルは日本全国を対象とすることから、日本全国を適用範囲とする空間参照系を適用する。水平方向は、「日本測地系2011における経緯度座標系」を採用する。また、高さ方向は、「東京湾平均海面を基準とする標高」を採用する。
 2次元座標の取り扱いについては、 B.4を参照すること。

**表 B-3 — B-2: データ集合の範囲を示す空間参照系**

| ID | `/req/gm/2` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | データ製品に適用する空間参照系は、データ集合（core:CityModel）の範囲（gml:boundedBy）を示すgml:EnvelopeのsrsName属性に記述する。 |

空間参照系の指定は、座標ごとに指定する、あるいは、これを含む幾何オブジェクトごとに指定するというように、いくつかの方法がある。3D都市モデルにおいては、空間参照系が一律に指定されることから、これらを包含するデータ集合であるcore:CityModelに対して空間参照系を指定する。
データ集合に記述する空間参照系は、これの定義を取得可能なURIにより指定する。

例1URIの例：http://www.opengis.net/def/crs/EPSG/0/6697

例2gml:Envelopeの属性srsNameに空間参照系のURIを記述する。属性srsDimensionには次元数を入れる。gml:lowerCornerには、緯度、経度及び標高の最小値を記載し、gml:upperCornerには最大値を記載する。

## B.3 幾何オブジェクト

## B.3.1 gml:pos, gml:posList

gml:posは直接座標、gml:posListは直接座標のリストの記述に用いる。

**表 B-4 — B-3: 座標値の空間参照系適合**

| ID | `/req/gm/3` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:pos及びgml:posListに含まれる座標値は、この幾何オブジェクトを含むデータ製品に適用された空間参照系に適合しなければならない。 |

gml:Envelopeの属性srsName座標で指定した空間参照系に基づく座標値を記述する。「日本測地系2011における経緯度座標系と東京湾平均海面を基準とする標高の複合座標参照系」の定義に従い、座標値は緯度、経度、標高の順列とし、それぞれを半角スペースで区切る。

「日本測地系2011における経緯度座標系と東京湾平均海面を基準とする標高の複合座標参照系」は、水平方向の「日本測地系2011における経緯度座標系」と高さ方向の「東京湾平均海面を基準とする標高」との複合座標参照系である。このとき、水平方向である「日本測地系2011における経緯度座標系」（EPSGコード：6668）では、その軸が、緯度、経度の順序で定義されている
 （参照：  [https://epsg.org/crs_6668/JGD2011.html?sessionkey=avd2dpqnm9](https://epsg.org/crs_6668/JGD2011.html?sessionkey=avd2dpqnm9) ）。
そのため、座標値が緯度、経度、標高の順列となる。

例1例2## B.3.2 gml:Point

gml:Pointは、点を記述するための幾何オブジェクトである。gml:posによりその位置を示す座標値を記述する。gml:Pointは識別子をもち、これを構成要素とする曲線（gml:_Curve）が参照できる。

例## B.3.3 gml:MultiPoint

gml:MultiPointは、点（gml:Point）の集まりを記述するための幾何オブジェクトである。gml:pointMemberにより構成する点を記述又は参照する。gml:MultiPointには、一つ以上の点が含まれていなくてはならない。

例## B.3.4 gml:_Curve, gml:LineString

gml:_Curveは曲線を記述するために使用される幾何オブジェクトであり、gml:LineStringは、gml:_Curveを継承する幾何オブジェクトであり、折れ線を示す。

**表 B-5 — B-4: 曲線記述のためのgml:LineString使用**

| ID | `/req/gm/4` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | データ製品に含まれる曲線の記述には、gml:_Curveの下位型であるgml:LineStringを使用する。 |

GMLには、gml:_Curveを継承する下位型として、様々な曲線を記述する型が用意されているが、3D都市モデルでは下位型のうち、gml:LineStringのみを実装の対象とする。

**表 B-6 — B-5: 妥当なgml:LineStringの条件**

| ID | `/req/gm/5` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 妥当なgml:LineStringは、以下を満たさなければならない。 |
| A | gml:LineStringを構成する点を、以下のいずれかの方法により記述する。gml:pos又はgml:pointPropertyの順列で構成する。gml:posListを用いて記述する。このとき、gml:posListには2点以上の座標値が含まれてなければならず、すべての座標値には同じ空間参照系が適用されなければならない。 |
| B | gml:LineStringを構成する点の座標値は、始点と終点が一致する場合を除き、一意とする。 |
| C | gml:LineStringは交差したり、重なったりしてはならない。 |

gml:LineStringは、2点以上の点から構成され、それらの点の順序は始点から終点までの順列になっていなければならない。始点と終点以外の点の座標が、他の点の座標と一致していてはならず、また、一つの折れ線に自己交差や重なりがあってはならない。

![Image](images/tocB_img001.png)

## B.3.5 gml:LinearRing

gml:LinearRingは、輪を記述するための幾何オブジェクトである。

**表 B-7 — B-6: gml:LinearRingの妥当性条件**

| ID | `/req/gm/6` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 妥当なgml:LinearRingは、以下を満たさなければならない。 |
| A | 3点以上の順列から構成され、始点と終点が一致する。 |
| B | gml:LinearRingを構成する全ての点は、始点と終点を除き、一致しない。 |
| C | 自己交差しない。 |

gml:LinearRingは、平面を示すgml:Polygonの外周や内周として使用する。gml:LinearRingは、閉じた輪でなければならず、自己交差や始終点以外の一致を許さない。gml:LinearRingを構成する全ての点が同一平面上にある場合、そのgml:LinearRingは平面となる。

![Image](images/tocB_img002.png)

## B.3.6 gml:_Surface, gml:Polygon

gml:_Surfaceは曲面を記述するために使用される幾何オブジェクトである。gml:Polygonは、gml:_Surfaceを継承する幾何オブジェクトであり、多角形を示す。

**表 B-8 — B-7: 曲面記述のためのgml:Polygon使用**

| ID | `/req/gm/7` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | データ製品に含まれる曲面の記述には、gml:_Surfaceの下位型であるgml:Polygonを使用することを原則とする。 |

GMLには、gml:_Surfaceを継承する下位型として、様々な曲面を記述する型が用意されているが、3D都市モデルでは下位型のうち、gml:Polygonを使用する。ただし地形のように、面的な広がりを有する地物型には、gml:TriangulatedSurface及びこの下位型を使用してよい。

**表 B-9 — B-8: gml:Polygonの外周と内周の関係**

| ID | `/req/gm/8` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:Polygonは一個の外周を必ずもち、また、0個以上複数個の内周をもってもよい。内周がある場合は、外周と内周とは同じ平面上に存在しなければなければならない。 |

gml:Polygonは、一個の外周をもち、また、0個以上の内周をもってもよい。外周及び内周はgml:LinearRingで記述される。gml:Polygonを構成する全ての点は同じ平面上に存在しなければならず、ゆがみやねじれがあってはならない。

**表 B-10 — B-9: gml:Polygonの向きと頂点の順列**

| ID | `/req/gm/9` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 外周の頂点の順列がgml:Polygonの向き（法線）を決める。頂点の順列が左回りのgml:Polygonは正の向きとなる。 |

![Image](images/tocB_img003.png)

**表 B-11 — B-10: gml:Polygonの妥当性条件**

| ID | `/req/gm/10` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 妥当なgml:Polygonは、以下を満たさなければならない。 |
| A | 内周が、外周に完全に含まれている。 |
| B | 内周が他の内周と重なっておらず、他の内周に包含されてもいない。 |
| C | 内周が外周に接していてもよいが、gml:Polygonの内部を分断しない。 |
| D | 内周と外周が線分で重ならない。 |
| E | 外周及び内周に自己交差がなく、始終点以外の点で一致する点がない。 |

![Image](images/tocB_img004.png)

## B.3.7 gml:OrientableSurface

gml:OrientableSurfaceは、向きをもつ曲面（有向曲面）である。属性orientationは曲面の向きを示し、gml:baseSurfaceは元とする曲面を参照する。

orientationの値が“+”となる場合は、元の曲面と同じ向きであることを示し、値が“-”の場合は、これは元の向きと反対の向きであることを示す。つまり、元の曲面（orientation=“+”）と反対の向きの曲面（orientation=“-”）は、表裏の関係にある。

gml:OrientableSurfaceは、接する複数の立体（gml:Solid）の境界を記述する場合に使用する。

![Image](images/tocB_img005.png)

例えば、図B-5に示すような立体Solid1とSolid2があったとする。これら二つの立体は、曲面Poly1を境界として接している。ここで、立体の境界となる曲面の向きは、常に、立体の内部から離れる向き（外側）を向いていなければならない。このとき、Poly1の向きがSolid1に対して外側に向いているとすると、Solid2にとっては内側を向いていることになる。そのため、Solid2の境界となる曲面として、Poly1と同じ位置に、反対の向き（Solid2とって外側の向き）となる曲面が必要となる。gml:OrientableSurfaceはこのような場合に使用する。Solid2を構成する外側境界である有向曲面OrientableSurface2は、gml:baseSurfaceによりPoly1を参照し、向きが反対（orientation=“-”）となる。

## B.3.8 gml:MultiSurface

gml:MultiSurfaceは、曲面の集合体を記述するための幾何オブジェクトである。構成要素となる曲面は、重なっていたり、離れていたりしてもよい。また、構成要素となる曲面の向きに制約はない。

## B.3.9 gml:CompositeSurface

gml:CompositeSurfaceは、合成曲面を記述するための幾何オブジェクトである。gml:MultiSurfaceと同様に、一個以上の曲面の集まりであるが、gml:MultiSurfaceとは異なり、以下を満たさなければならない。

**表 B-12 — B-11: gml:CompositeSurfaceの妥当性条件**

| ID | `/req/gm/11` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 妥当なgml:CompositeSurfaceは、以下を満たさなければならない。 |
| A | 構成要素となる曲面が連続しており、全体として一個の曲面を構成する。 |

![Image](images/tocB_img006.png)

gml:CompositeSurfaceの構成要素は、gml:_Surfaceを継承する幾何オブジェクトのみであり、
 gml:MultiSurfaceはその構成要素とはなりえないことに注意すること。 
これは、gml:MultiSurfaceがgml:_Surfaceを継承していないからである。

## B.3.10 gml:Solid

gml:Solidは、立体を記述するための幾何オブジェクトである。

**表 B-13 — B-12: 立体記述のためのgml:Solid使用**

| ID | `/req/gm/12` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | データ製品に含まれる立体の記述には、gml:Solidを使用する。 |

CityGMLでは、立体を記述するための幾何オブジェクトとして、gml:Solidとこれの集まりであるgml:CompositeSolidが存在する。しかしながら、gml:CompositeSolidに対応するソフトウェアが現時点ではないことから、3D都市モデルでは、gml:Solidを使用する。

**表 B-14 — B-13: gml:Solidの外側境界と内側境界**

| ID | `/req/gm/13` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:Solidは一個の外側境界を必ずもち、また、0個以上複数個の内側境界をもってもよい。 |

gml:Solidは、外側境界（殻）を必ずもたなければならない。また、その内部にも境界をもつこともできる。

**表 B-15 — B-14: gml:Solidの妥当性条件**

| ID | `/req/gm/14` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | 妥当なgml:Solidは、以下を満たさなければならない。 |
| A | gml:Solidの境界を構成する曲面が、自己交差していない。 |
| B | gml:Solidは閉じている（水密である）。 |
| C | gml:Solidの内部が連続している。 |
| D | gml:Solidの境界を構成する曲面が、適切な方向を向いている。 |
| E | gml:Solidの境界を構成する曲面が、重なっていない。 |

![Image](images/tocB_img007.png)

立体を構成する境界の記述には、合成曲面（gml:CompositeSurface）を使用する。合成曲面は連続していなければならず、重なったり、離れていたりしてはならない。また、立体の境界となる合成曲面は、閉じていなければならない。

![Image](images/tocB_img008.png)

立体を構成する境界となる曲面の向きは、立体の内部から離れる方向を向いていなければならない。

## B.3.11 gml:Triangle

gml:Triangleは、三角形を記述するための幾何オブジェクトである。この幾何オブジェクトは、gml:TriangulatedSurfaceを構成するために用いる。

**表 B-16 — B-15: gml:Triangleの外周と内周の制約**

| ID | `/req/gm/15` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:Triangleは、4点（ただし、始点と終点は一致する）のみからなる外周を有する。内周をもってはならない。 |

## B.3.12 gml:TriangulatedSurface

gml:TriangulatedSurfaceは、複数の三角形だけから構成した合成曲面（gml:CompositeSurface）を記述するための幾何オブジェクトである。

**表 B-17 — B-16: gml:TriangulatedSurfaceの構成要素**

| ID | `/req/gm/16` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:TrianglatedSurfaceは、gml:Triangleのみをその構成要素とする。 |

gml:TriangulatedSurfaceは、閉じておらず、境界をもつことができる。どのように三角形分割するかの制約はもたない。ここでの「閉じていない」とは、立体の境界のような「殻」にはなっていないという意味である。

## B.3.13 gml:Tin

gml:Tinは、不規則三角網と呼ばれ、三点以上の制御点（gml:controlPoint）が隣接する複数の三角形を構成し、それぞれが小平面分を形成する幾何オブジェクトである。gml:TriangulatedSurfaceとは異なり、明示的な三角形は保持しない。

gml:Tinは、ドローネアルゴリズム又はこれに抑止線、傾斜変換線及び三角形の最大辺長に対する考慮を補った同様のアルゴリズムを使用した三角網である。

**表 B-18 — B-17: gml:Tinの制御点と三角形の条件**

| ID | `/req/gm/17` |
| --- | --- |
| 主題 | 妥当な幾何オブジェクトの要件 |
| 分類 | 要件分類B-1: 妥当な幾何オブジェクト |
| 条文 | gml:Tinの制御点は、必ず三点以上を含まなければならない。また、制御点から構成される三角形の頂点を通過する円は、他の三角形の頂点を含んではならない。 |

gml:Tinはアルゴリズムを使用し三角形が形成されるため、これを実装するアプリケーションソフトウェアによって異なる三角形が形成される可能性がある（図B-9）。
これは、gml:TriangulatedSurfaceを使用し、明示的に三角形を保持することで回避できる。

![Image](images/tocB_img009.png)

## B.4 CityGMLにおける2次元の空間参照系の取り扱い

標準製品仕様書では、幾何オブジェクトの座標値に適用する空間参照系として、3次元の空間参照系である「日本測地系2011における経緯度座標系と東京湾平均海面を基準とする標高の複合座標参照系」を採用している。これは、標準製品仕様書が準拠する国際標準であるCityGMLが、3次元の都市空間を記述することを目的として設計されているためである。しかしながら、ユースケースによっては高さを必要とせず、幾何オブジェクトの座標値は2次元でよい場合も想定される。（例：3次元の地形データにドレープして使用するため、高さが不要）

CityGMLでは、採用すべき空間参照系は規定されていない。一方で、前述したようにCityGMLが3次元の都市空間を対象としていることから、CityGML対応ツールには3次元の座標値の読み込みにしか対応しておらず、2次元座標を正しく読み込めない場合がある。これを踏まえ、既存のCityGML対応ツールでの読み込みを可能とするための暫定的な処置となるが、2次元座標により記述された幾何オブジェクトを3D都市モデルに記述する方策を示す。以下で示す以外の事項については、前項までに示した要件に従うこと。

## B.4.1 空間参照系

3D都市モデルは日本全国を対象とすることから、日本全国を適用範囲とする空間参照系として、2次元の空間参照系においても、水平方向は「日本測地系2011における経緯度座標系」を採用する。

ただし、前述のとおり、2次元の空間参照系に対応しないツールが多いことから、3D都市モデルでは以下のように空間参照系を指定する。

例本来、「日本測地系2011における経緯度座標系」が適用された場合srsName属性で指定する空間参照系のURIは、「日本測地系2011における経緯度座標系」の定義を取得可能なURI
 （例：http://www.opengis.net/def/crs/EPSG/0/6668 ）であり、次元数を示すsrsDimension属性の値は2である。 
しかしながら、CityGMLは3次元座標の地理空間データの記述を対象としていることからCityGML対応のソフトウェアの中には、2次元座標の地理空間データを読み込めないものもある。そのため、暫定的な対応として高さの最小範囲・最大範囲に0.0を入れ、次元数に3を記述する。

## B.4.2 座標値の記述

gml:pos又はgml:posListを用いて座標値を記述する場合、2次元座標により記述された幾何オブジェクトには仮想的な高さとして0.0を与える。

## B.4.3 留意事項

本項で示す2次元座標により記述された幾何オブジェクトを3D都市モデルに記述する場合の推奨規則は、暫定的な対応である。そのため、これが適用されていることを3D都市モデルの利用者に明示する必要がある。

具体的には、3D都市モデルの説明情報となるメタデータの要約（識別情報の要約）に以下の文言を記載する。
 「3D都市モデルに含まれるすべての座標は、緯度・経度・標高の3つの座標値の組から構成されています。そのため、2次元の空間参照系が適用されている●●（対象となる地物型を列挙）の座標には、標高に0.0が記述されています。この場合の0.0が実際の標高ではないことに注意してください。」

